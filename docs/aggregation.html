<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggregation èšåˆæ¨¡å— - è”é‚¦å­¦ä¹ æ¡†æ¶æ–‡æ¡£</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>ğŸš€ è”é‚¦å­¦ä¹ æ¡†æ¶</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                <li><a href="core.html" class="nav-link">Core</a></li>
                <li><a href="communication.html" class="nav-link">Communication</a></li>
                <li><a href="data.html" class="nav-link">Data</a></li>
                <li><a href="models.html" class="nav-link">Models</a></li>
                <li><a href="utils.html" class="nav-link">Utils</a></li>
                <li><a href="execution-flow.html" class="nav-link">æ‰§è¡Œæµç¨‹</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <a href="index.html" class="back-button">â† è¿”å›é¦–é¡µ</a>
        
        <header class="hero">
            <h1>ğŸ”— Aggregation èšåˆæ¨¡å—</h1>
            <p class="hero-subtitle">è”é‚¦å­¦ä¹ æ¨¡å‹èšåˆç®—æ³•çš„å®ç°</p>
        </header>

        <div class="content-section">
            <h2>æ¨¡å—æ¦‚è¿°</h2>
            <p>Aggregation æ¨¡å—å®ç°äº†è”é‚¦å­¦ä¹ ä¸­çš„æ¨¡å‹èšåˆç®—æ³•ï¼Œä¸»è¦è´Ÿè´£å°†å¤šä¸ªå®¢æˆ·ç«¯çš„æœ¬åœ°æ¨¡å‹æ›´æ–°åˆå¹¶ä¸ºå…¨å±€æ¨¡å‹ã€‚è¯¥æ¨¡å—ç›®å‰å®ç°äº†ç»å…¸çš„ FedAvgï¼ˆè”é‚¦å¹³å‡ï¼‰ç®—æ³•ï¼Œå¹¶æä¾›äº†æ˜“äºæ‰©å±•çš„æ¡†æ¶æ¥æ”¯æŒå…¶ä»–èšåˆç­–ç•¥ã€‚</p>
            
            <div class="info-box">
                <strong>æ ¸å¿ƒåŠŸèƒ½ï¼š</strong> å°†åˆ†å¸ƒå¼è®­ç»ƒçš„å®¢æˆ·ç«¯æ¨¡å‹å‚æ•°å®‰å…¨é«˜æ•ˆåœ°èšåˆä¸ºç»Ÿä¸€çš„å…¨å±€æ¨¡å‹ã€‚
            </div>
        </div>

        <div class="content-section">
            <h2>ğŸ“ æ–‡ä»¶ç»“æ„</h2>
            <pre><code>aggregation/
â”œâ”€â”€ __init__.py          # æ¨¡å—åˆå§‹åŒ–
â””â”€â”€ federated_avg.py     # FedAvg è”é‚¦å¹³å‡ç®—æ³•å®ç°</code></pre>
        </div>

        <div class="content-section">
            <h2>ğŸ§® FederatedAveraging è”é‚¦å¹³å‡ç®—æ³•</h2>
            <p>FedAvg æ˜¯æœ€ç»å…¸çš„è”é‚¦å­¦ä¹ èšåˆç®—æ³•ï¼Œé€šè¿‡å¯¹å®¢æˆ·ç«¯æ¨¡å‹å‚æ•°è¿›è¡ŒåŠ æƒå¹³å‡æ¥æ›´æ–°å…¨å±€æ¨¡å‹ã€‚è¯¥å®ç°æ”¯æŒå‡ç­‰æƒé‡å’Œè‡ªå®šä¹‰æƒé‡ä¸¤ç§æ¨¡å¼ã€‚</p>
            
            <h3>ç®—æ³•åŸç†</h3>
            <div class="architecture-content">
                <div class="architecture-diagram">
                    <div class="arch-layer">
                        <h4>1. æ”¶é›†å®¢æˆ·ç«¯æ›´æ–°</h4>
                        <div class="arch-components">
                            <span>å®¢æˆ·ç«¯å‚æ•°</span>
                            <span>è®­ç»ƒæŒ‡æ ‡</span>
                        </div>
                    </div>
                    <div class="arch-layer">
                        <h4>2. æƒé‡è®¡ç®—</h4>
                        <div class="arch-components">
                            <span>å‡ç­‰æƒé‡</span>
                            <span>è‡ªå®šä¹‰æƒé‡</span>
                            <span>æƒé‡å½’ä¸€åŒ–</span>
                        </div>
                    </div>
                    <div class="arch-layer">
                        <h4>3. å‚æ•°èšåˆ</h4>
                        <div class="arch-components">
                            <span>åŠ æƒå¹³å‡</span>
                            <span>é€å±‚è®¡ç®—</span>
                        </div>
                    </div>
                    <div class="arch-layer">
                        <h4>4. è¿”å›ç»“æœ</h4>
                        <div class="arch-components">
                            <span>èšåˆå‚æ•°</span>
                            <span>å…¨å±€æ¨¡å‹</span>
                        </div>
                    </div>
                </div>
                
                <div class="architecture-description">
                    <h4>ç®—æ³•ç‰¹ç‚¹</h4>
                    <ul>
                        <li><strong>åŠ æƒå¹³å‡</strong>ï¼šæ”¯æŒåŸºäºæ•°æ®é‡æˆ–æ€§èƒ½çš„æƒé‡åˆ†é…</li>
                        <li><strong>å‚æ•°ä¿æŠ¤</strong>ï¼šä½¿ç”¨æ·±æ‹·è´é¿å…åŸå§‹æ•°æ®è¢«ä¿®æ”¹</li>
                        <li><strong>ç±»å‹å…¼å®¹</strong>ï¼šæ”¯æŒæ–°æ—§ä¸¤ç§æ•°æ®æ ¼å¼</li>
                        <li><strong>é²æ£’æ€§</strong>ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2>ğŸ”§ æ ¸å¿ƒæ–¹æ³•è¯¦è§£</h2>
            
            <h3>åˆå§‹åŒ–æ–¹æ³•</h3>
            <ul class="method-list">
                <li>
                    <div class="method-signature">__init__()</div>
                    <div class="method-description">åˆå§‹åŒ–è”é‚¦å¹³å‡èšåˆå™¨ï¼Œæ— éœ€å‚æ•°</div>
                </li>
            </ul>

            <h3>èšåˆæ–¹æ³•</h3>
            <ul class="method-list">
                <li>
                    <div class="method-signature">aggregate(client_updates: List[Dict[str, Any]], client_weights: Dict[str, float] = None) -> Dict[str, Any]</div>
                    <div class="method-description">æ‰§è¡Œè”é‚¦å¹³å‡èšåˆï¼Œè¿”å›èšåˆåçš„æ¨¡å‹å‚æ•°</div>
                </li>
            </ul>

            <h3>å‚æ•°è¯´æ˜</h3>
            <table class="property-table">
                <tr>
                    <th>å‚æ•°å</th>
                    <th>ç±»å‹</th>
                    <th>æè¿°</th>
                </tr>
                <tr>
                    <td>client_updates</td>
                    <td>List[Dict[str, Any]]</td>
                    <td>å®¢æˆ·ç«¯æ›´æ–°åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« 'parameters' å’Œ 'metrics'</td>
                </tr>
                <tr>
                    <td>client_weights</td>
                    <td>Dict[str, float]</td>
                    <td>å®¢æˆ·ç«¯æƒé‡å­—å…¸ï¼Œå¦‚æœä¸º None åˆ™ä½¿ç”¨å‡ç­‰æƒé‡</td>
                </tr>
            </table>

            <h3>è¿”å›å€¼</h3>
            <table class="property-table">
                <tr>
                    <th>è¿”å›ç±»å‹</th>
                    <th>æè¿°</th>
                </tr>
                <tr>
                    <td>Dict[str, Any]</td>
                    <td>èšåˆåçš„æ¨¡å‹å‚æ•°å­—å…¸ï¼Œå¯ç›´æ¥ç”¨äºæ¨¡å‹æ›´æ–°</td>
                </tr>
            </table>
        </div>

        <div class="content-section">
            <h2>ğŸ“Š èšåˆè¿‡ç¨‹è¯¦è§£</h2>
            
            <h3>1. å‚æ•°æå–</h3>
            <pre><code># æ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼
# æ–°æ ¼å¼ï¼š{'parameters': {...}, 'metrics': {...}}
# æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯å‚æ•°å­—å…¸

client_params_list = []
for update in client_updates:
    if isinstance(update, dict) and 'parameters' in update:
        client_params_list.append(update['parameters'])  # æ–°æ ¼å¼
    else:
        client_params_list.append(update)  # å‘åå…¼å®¹æ—§æ ¼å¼</code></pre>

            <h3>2. æƒé‡å¤„ç†</h3>
            <pre><code># æƒé‡å½’ä¸€åŒ–
if client_weights is None or len(client_weights) == 0:
    # å‡ç­‰æƒé‡
    num_clients = len(client_params_list)
    weights = [1.0 / num_clients] * num_clients
else:
    # è‡ªå®šä¹‰æƒé‡
    weights = list(client_weights.values())
    total_weight = sum(weights)
    weights = [w / total_weight for w in weights]  # å½’ä¸€åŒ–</code></pre>

            <h3>3. å‚æ•°èšåˆ</h3>
            <pre><code># åŠ æƒå¹³å‡èšåˆ
for i, client_params in enumerate(client_params_list):
    weight = weights[i]
    
    if aggregated_params is None:
        # åˆå§‹åŒ–èšåˆå‚æ•°ï¼ˆæ·±æ‹·è´ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å‚æ•°ï¼‰
        aggregated_params = copy.deepcopy(client_params)
        for key in aggregated_params:
            aggregated_params[key] *= weight
    else:
        # ç´¯åŠ åŠ æƒå‚æ•°
        for key in client_params:
            if key in aggregated_params:
                aggregated_params[key] += client_params[key] * weight</code></pre>
        </div>

        <div class="content-section">
            <h2>ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹</h2>
            
            <h3>åŸºç¡€ä½¿ç”¨ï¼ˆå‡ç­‰æƒé‡ï¼‰</h3>
            <pre><code># åˆ›å»ºèšåˆå™¨
aggregator = FederatedAveraging()

# å®¢æˆ·ç«¯æ›´æ–°ï¼ˆæ–°æ ¼å¼ï¼‰
client_updates = [
    {
        'parameters': client1_params,
        'metrics': {'loss': 0.1, 'accuracy': 0.95}
    },
    {
        'parameters': client2_params,
        'metrics': {'loss': 0.15, 'accuracy': 0.92}
    },
    {
        'parameters': client3_params,
        'metrics': {'loss': 0.12, 'accuracy': 0.94}
    }
]

# æ‰§è¡Œèšåˆ
aggregated_params = aggregator.aggregate(client_updates)
print(f"èšåˆå®Œæˆï¼Œå‚æ•°å±‚æ•°: {len(aggregated_params)}")</code></pre>

            <h3>ä½¿ç”¨è‡ªå®šä¹‰æƒé‡</h3>
            <pre><code># åŸºäºæ•°æ®é‡çš„æƒé‡åˆ†é…
client_weights = {
    'client_0': 100,  # 100ä¸ªæ ·æœ¬
    'client_1': 150,  # 150ä¸ªæ ·æœ¬
    'client_2': 80    # 80ä¸ªæ ·æœ¬
}

# æ‰§è¡ŒåŠ æƒèšåˆ
aggregated_params = aggregator.aggregate(client_updates, client_weights)

# æƒé‡ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ï¼š
# client_0: 100/330 â‰ˆ 0.303
# client_1: 150/330 â‰ˆ 0.455  
# client_2: 80/330 â‰ˆ 0.242</code></pre>

            <h3>åœ¨æœåŠ¡å™¨ä¸­ä½¿ç”¨</h3>
            <pre><code>class FederatedServer(BaseServer):
    def __init__(self, global_model, aggregator):
        super().__init__()
        self.global_model = global_model
        self.aggregator = aggregator
        self.client_weights = {}
    
    def aggregate(self, client_updates):
        # ä½¿ç”¨èšåˆå™¨è¿›è¡Œèšåˆ
        aggregated_params = self.aggregator.aggregate(
            client_updates, 
            self.client_weights
        )
        
        # æ›´æ–°å…¨å±€æ¨¡å‹
        self.global_model.set_parameters(aggregated_params)
        
        return aggregated_params</code></pre>

            <h3>å¤„ç†å¼‚å¸¸æƒ…å†µ</h3>
            <pre><code>def safe_aggregate(aggregator, client_updates, client_weights=None):
    try:
        if not client_updates:
            print("âš ï¸ æ²¡æœ‰å®¢æˆ·ç«¯æ›´æ–°")
            return None
        
        aggregated_params = aggregator.aggregate(client_updates, client_weights)
        print(f"âœ“ æˆåŠŸèšåˆ {len(client_updates)} ä¸ªå®¢æˆ·ç«¯æ›´æ–°")
        return aggregated_params
        
    except ValueError as e:
        print(f"âŒ èšåˆå¤±è´¥: {e}")
        return None
    except Exception as e:
        print(f"âŒ æ„å¤–é”™è¯¯: {e}")
        return None</code></pre>
        </div>

        <div class="content-section">
            <h2>ğŸ”§ æ‰©å±•å…¶ä»–èšåˆç®—æ³•</h2>
            
            <h3>FedProx èšåˆç®—æ³•</h3>
            <pre><code>class FederatedProx:
    """FedProx èšåˆç®—æ³•å®ç°"""
    
    def __init__(self, mu=0.01):
        self.mu = mu  # æ­£åˆ™åŒ–å‚æ•°
    
    def aggregate(self, client_updates, client_weights=None, global_model_params=None):
        # åŸºç¡€ FedAvg èšåˆ
        basic_aggregator = FederatedAveraging()
        aggregated_params = basic_aggregator.aggregate(client_updates, client_weights)
        
        if global_model_params is not None:
            # æ·»åŠ  FedProx æ­£åˆ™åŒ–
            for key in aggregated_params:
                if key in global_model_params:
                    # å‘å…¨å±€æ¨¡å‹å‚æ•°æ”¶æ•›
                    aggregated_params[key] = (
                        aggregated_params[key] * (1 - self.mu) + 
                        global_model_params[key] * self.mu
                    )
        
        return aggregated_params</code></pre>

            <h3>åŸºäºæ€§èƒ½çš„è‡ªé€‚åº”æƒé‡</h3>
            <pre><code>class AdaptiveWeightAggregator:
    """åŸºäºå®¢æˆ·ç«¯æ€§èƒ½çš„è‡ªé€‚åº”æƒé‡èšåˆ"""
    
    def __init__(self, alpha=0.5):
        self.alpha = alpha  # æ€§èƒ½æƒé‡å› å­
    
    def calculate_performance_weights(self, client_updates):
        """åŸºäºå‡†ç¡®ç‡è®¡ç®—æƒé‡"""
        weights = {}
        accuracies = []
        
        # æå–å‡†ç¡®ç‡
        for i, update in enumerate(client_updates):
            if 'metrics' in update and 'accuracy' in update['metrics']:
                accuracy = update['metrics']['accuracy']
            else:
                accuracy = 0.5  # é»˜è®¤å€¼
            accuracies.append(accuracy)
        
        # è½¬æ¢ä¸ºæƒé‡ï¼ˆå‡†ç¡®ç‡è¶Šé«˜æƒé‡è¶Šå¤§ï¼‰
        total_accuracy = sum(accuracies)
        if total_accuracy > 0:
            for i, accuracy in enumerate(accuracies):
                weights[f'client_{i}'] = accuracy / total_accuracy
        else:
            # å‡ç­‰æƒé‡ä½œä¸ºåå¤‡
            for i in range(len(client_updates)):
                weights[f'client_{i}'] = 1.0 / len(client_updates)
        
        return weights
    
    def aggregate(self, client_updates, data_weights=None):
        # è®¡ç®—æ€§èƒ½æƒé‡
        perf_weights = self.calculate_performance_weights(client_updates)
        
        # ç»“åˆæ•°æ®é‡æƒé‡å’Œæ€§èƒ½æƒé‡
        if data_weights is not None:
            combined_weights = {}
            for key in perf_weights:
                if key in data_weights:
                    combined_weights[key] = (
                        self.alpha * perf_weights[key] + 
                        (1 - self.alpha) * data_weights[key]
                    )
                else:
                    combined_weights[key] = perf_weights[key]
        else:
            combined_weights = perf_weights
        
        # ä½¿ç”¨åŸºç¡€èšåˆå™¨
        aggregator = FederatedAveraging()
        return aggregator.aggregate(client_updates, combined_weights)</code></pre>

            <h3>å®‰å…¨èšåˆï¼ˆByzantine-robustï¼‰</h3>
            <pre><code>class ByzantineRobustAggregator:
    """æ‹œå åº­å®¹é”™èšåˆç®—æ³•"""
    
    def __init__(self, byzantine_ratio=0.2):
        self.byzantine_ratio = byzantine_ratio
    
    def trim_mean_aggregate(self, client_updates, trim_ratio=0.2):
        """Trimmed Mean èšåˆ"""
        if not client_updates:
            raise ValueError("No client updates provided")
        
        # æå–å‚æ•°
        client_params_list = []
        for update in client_updates:
            if isinstance(update, dict) and 'parameters' in update:
                client_params_list.append(update['parameters'])
            else:
                client_params_list.append(update)
        
        aggregated_params = {}
        
        # å¯¹æ¯ä¸ªå‚æ•°å±‚è¿›è¡Œ trimmed mean
        for key in client_params_list[0].keys():
            param_values = [params[key] for params in client_params_list]
            
            # è®¡ç®—éœ€è¦ä¿®å‰ªçš„æ•°é‡
            n_clients = len(param_values)
            n_trim = int(n_clients * trim_ratio / 2)
            
            if n_trim > 0:
                # æŒ‰å€¼æ’åºå¹¶ä¿®å‰ªæå€¼
                sorted_values = sorted(param_values, key=lambda x: torch.norm(x).item())
                trimmed_values = sorted_values[n_trim:-n_trim] if n_trim < n_clients//2 else sorted_values
            else:
                trimmed_values = param_values
            
            # è®¡ç®—å‡å€¼
            if trimmed_values:
                aggregated_params[key] = sum(trimmed_values) / len(trimmed_values)
            else:
                aggregated_params[key] = param_values[0]  # åå¤‡æ–¹æ¡ˆ
        
        return aggregated_params</code></pre>
        </div>

        <div class="content-section">
            <h2>ğŸ“ˆ æ€§èƒ½åˆ†æä¸ä¼˜åŒ–</h2>
            
            <h3>è®¡ç®—å¤æ‚åº¦</h3>
            <ul>
                <li><strong>æ—¶é—´å¤æ‚åº¦ï¼š</strong> O(n Ã— p)ï¼Œå…¶ä¸­ n æ˜¯å®¢æˆ·ç«¯æ•°é‡ï¼Œp æ˜¯å‚æ•°æ•°é‡</li>
                <li><strong>ç©ºé—´å¤æ‚åº¦ï¼š</strong> O(p)ï¼Œä¸»è¦ç”¨äºå­˜å‚¨èšåˆåçš„å‚æ•°</li>
                <li><strong>é€šä¿¡å¤æ‚åº¦ï¼š</strong> O(n Ã— p)ï¼Œéœ€è¦ä¼ è¾“æ‰€æœ‰å®¢æˆ·ç«¯å‚æ•°</li>
            </ul>

            <h3>ä¼˜åŒ–ç­–ç•¥</h3>
            <div class="warning-box">
                <strong>å†…å­˜ä¼˜åŒ–ï¼š</strong> å¯¹äºå¤§å‹æ¨¡å‹ï¼Œè€ƒè™‘é€å±‚èšåˆè€Œéä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å‚æ•°ã€‚
            </div>
            
            <div class="info-box">
                <strong>å¹¶è¡Œå¤„ç†ï¼š</strong> å¯ä»¥å¹¶è¡Œè®¡ç®—ä¸åŒå±‚çš„å‚æ•°èšåˆï¼Œæé«˜è®¡ç®—æ•ˆç‡ã€‚
            </div>
            
            <pre><code># å†…å­˜å‹å¥½çš„é€å±‚èšåˆç¤ºä¾‹
def memory_efficient_aggregate(self, client_updates, client_weights=None):
    """å†…å­˜å‹å¥½çš„èšåˆå®ç°"""
    if not client_updates:
        raise ValueError("No client updates provided")
    
    # è·å–å‚æ•°é”®åˆ—è¡¨
    param_keys = list(client_updates[0]['parameters'].keys())
    aggregated_params = {}
    
    # é€å±‚èšåˆ
    for key in param_keys:
        layer_params = []
        for update in client_updates:
            layer_params.append(update['parameters'][key])
        
        # èšåˆå½“å‰å±‚
        aggregated_layer = self._aggregate_single_layer(layer_params, client_weights)
        aggregated_params[key] = aggregated_layer
        
        # æ¸…ç†ä¸´æ—¶æ•°æ®
        del layer_params
    
    return aggregated_params</code></pre>
        </div>

        <div class="content-section">
            <h2>âš ï¸ æ³¨æ„äº‹é¡¹</h2>
            <div class="warning-box">
                <strong>æ•°æ®æ ¼å¼ï¼š</strong> ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯æ›´æ–°å…·æœ‰ç›¸åŒçš„å‚æ•°ç»“æ„å’Œæ•°æ®ç±»å‹ã€‚
            </div>
            
            <div class="warning-box">
                <strong>æƒé‡å½’ä¸€åŒ–ï¼š</strong> è‡ªå®šä¹‰æƒé‡ä¼šè‡ªåŠ¨å½’ä¸€åŒ–ï¼Œç¡®ä¿æƒé‡æ€»å’Œä¸º 1ã€‚
            </div>
            
            <div class="warning-box">
                <strong>å¼‚å¸¸å¤„ç†ï¼š</strong> å½“æ²¡æœ‰å®¢æˆ·ç«¯æ›´æ–°æ—¶ï¼Œaggregate æ–¹æ³•ä¼šæŠ›å‡º ValueErrorã€‚
            </div>
            
            <div class="info-box">
                <strong>å‘åå…¼å®¹ï¼š</strong> æ”¯æŒæ–°æ—§ä¸¤ç§å®¢æˆ·ç«¯æ›´æ–°æ ¼å¼ï¼Œä¾¿äºæ¸è¿›å¼å‡çº§ã€‚
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 è”é‚¦å­¦ä¹ æ¡†æ¶. æ‰€æœ‰æƒåˆ©ä¿ç•™.</p>
            <p><a href="communication.html">ä¸Šä¸€é¡µï¼šCommunication æ¨¡å—</a> | <a href="data.html">ä¸‹ä¸€é¡µï¼šData æ¨¡å—</a></p>
        </div>
    </footer>

    <script src="assets/script.js"></script>
</body>
</html>
